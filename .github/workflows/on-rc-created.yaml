name: Handle RC created (temporary: immediate promotion)

on:
  repository_dispatch:
    types: [rc-created]

permissions:
  contents: read

env:
  # Just a label for future use; not strictly required
  PROMOTE_EVENT_TYPE: promote-rc

jobs:
  handle-rc:
    runs-on: ubuntu-latest

    steps:
      - name: Show received payload (debug)
        run: |
          echo "Full event:"
          echo '${{ toJson(github.event) }}'

      - name: Extract payload (source repo and tag)
        id: payload
        run: |
          SRC_REPO="${{ github.event.client_payload.source_repo }}"
          TAG="${{ github.event.client_payload.tag }}"
          RELEASE_URL="${{ github.event.client_payload.release_url }}"

          if [ -z "$SRC_REPO" ] || [ -z "$TAG" ]; then
            echo "Missing source_repo or tag in client_payload"
            echo "source_repo='$SRC_REPO'"
            echo "tag='$TAG'"
            exit 1
          fi

          echo "source_repo=$SRC_REPO" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "release_url=$RELEASE_URL" >> "$GITHUB_OUTPUT"

          echo "Received RC:"
          echo "  source_repo: $SRC_REPO"
          echo "  tag:         $TAG"
          echo "  release_url: $RELEASE_URL"

      - name: Generate installation token (GitHub App)
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP__CI_ORCHESTRATOR__ID }}
          private-key: ${{ secrets.GH_APP__CI_ORCHESTRATOR__PRIVATE_KEY }}

      # ⚠️ TEMP: Immediately promote the RC (no subscribers yet)
      - name: Send promote-rc to source repo
        run: |
          SRC_REPO="${{ steps.payload.outputs.source_repo }}"
          TAG="${{ steps.payload.outputs.tag }}"

          echo "Sending promote-rc to $SRC_REPO for tag $TAG"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            "https://api.github.com/repos/$SRC_REPO/dispatches" \
            -d @- <<EOF
          {
            "event_type": "${{ env.PROMOTE_EVENT_TYPE }}",
            "client_payload": {
              "tag": "$TAG"
            }
          }
          EOF
