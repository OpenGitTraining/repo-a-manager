name: Handle RC created
run-name: Handle RC created

on:
  repository_dispatch:
    types: [rc-created]

permissions:
  contents: read

env:
  # Just a label for future use; not strictly required
  INTEGRATION_REPO: OpenGitTraining/integration-tests-AB
  TEST_EVENT_TYPE: repo-a-test-request
  # PROMOTE_EVENT_TYPE: promote-rc # MOVED to new workflow

jobs:
  handle-rc:
    runs-on: ubuntu-latest

    steps:
      - name: Show received payload (debug)
        run: |
          echo "Full event:"
          echo '${{ toJson(github.event) }}'

      - name: Extract payload (source repo and tag)
        id: payload
        run: |
          SRC_REPO="${{ github.event.client_payload.source_repo }}"
          TAG="${{ github.event.client_payload.tag }}"
          RELEASE_URL="${{ github.event.client_payload.release_url }}"

          if [ -z "$SRC_REPO" ] || [ -z "$TAG" ]; then
            echo "Missing source_repo or tag in client_payload"
            echo "source_repo='$SRC_REPO'"
            echo "tag='$TAG'"
            exit 1
          fi

          echo "source_repo=$SRC_REPO" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "release_url=$RELEASE_URL" >> "$GITHUB_OUTPUT"

          echo "Received RC:"
          echo "  source_repo: $SRC_REPO"
          echo "  tag:         $TAG"
          echo "  release_url: $RELEASE_URL"

      - name: Generate installation token (GitHub App)
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP__CI_ORCHESTRATOR__ID }}
          private-key: ${{ secrets.GH_APP__CI_ORCHESTRATOR__PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            repo-a
            repo-a-manager
            integration-tests-AB

      - name: Send Test Request
        run: |
          TAG="${{ steps.payload.outputs.tag }}"
          SRC_REPO="${{ steps.payload.outputs.source_repo }}"
          RELEASE_URL="${{ steps.payload.outputs.release_url }}"

          echo "Requesting integration tests in ${{ env.INTEGRATION_REPO }} for $SRC_REPO@$TAG"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            "https://api.github.com/repos/${{ env.INTEGRATION_REPO }}/dispatches" \
            -d @- <<EOF
          {
            "event_type": "${{ env.TEST_EVENT_TYPE }}",
            "client_payload": {
              "source_repo": "$SRC_REPO",
              "tag": "$TAG",
              "release_url": "$RELEASE_URL"
            }
          }
          EOF
